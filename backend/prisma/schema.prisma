generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model batteries {
  battery_id                                          String                  @id @db.Uuid
  battery_code                                        String                  @unique @db.VarChar(50)
  station_id                                          String                  @db.Uuid
  model                                               String                  @db.VarChar(50)
  capacity_kwh                                        Decimal?                @db.Decimal(6, 2)
  voltage                                             Decimal?                @db.Decimal(6, 2)
  current_charge                                      Int                     @default(100)
  status                                              BatteryStatus           @default(full)
  last_charged_at                                     DateTime?
  created_at                                          DateTime                @default(now())
  updated_at                                          DateTime
  health_percentage                                   Decimal?                @db.Decimal(5, 2)
  cycle_count                                         Int?                    @default(0)
  stations                                            stations                @relation(fields: [station_id], references: [station_id])
  battery_history                                     battery_history[]
  battery_transfer_logs                               battery_transfer_logs[]
  transactions_transactions_new_battery_idTobatteries transactions[]          @relation("transactions_new_battery_idTobatteries")
  transactions_transactions_old_battery_idTobatteries transactions[]          @relation("transactions_old_battery_idTobatteries")
  vehicles                                            vehicles[]

  @@index([model])
  @@index([station_id, status])
  @@index([status, current_charge])
}

model battery_history {
  history_id    String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  battery_id    String               @db.Uuid
  booking_id    String?              @db.Uuid
  vehicle_id    String?              @db.Uuid
  station_id    String?              @db.Uuid
  action        BatteryHistoryAction @default(reserved)
  actor_user_id String?              @db.Uuid
  notes         String?
  metadata      Json?
  created_at    DateTime             @default(now())
  users         users?               @relation(fields: [actor_user_id], references: [user_id], onUpdate: NoAction)
  batteries     batteries            @relation(fields: [battery_id], references: [battery_id], onDelete: Cascade, onUpdate: NoAction)
  bookings      bookings?            @relation(fields: [booking_id], references: [booking_id], onDelete: Cascade, onUpdate: NoAction)
  vehicles      vehicles?            @relation(fields: [vehicle_id], references: [vehicle_id], onUpdate: NoAction)

  @@index([battery_id, created_at])
  @@index([booking_id])
}

model battery_pricings {
  pricing_id    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  battery_model String   @db.VarChar(50)
  station_id    String?  @db.Uuid
  price         Decimal  @db.Decimal(10, 2)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now())
  stations      stations? @relation(fields: [station_id], references: [station_id], onDelete: Cascade)

  @@unique([battery_model, station_id])
  @@index([battery_model])
  @@index([is_active])
}

model battery_transfer_logs {
  transfer_id                                              String          @id @db.Uuid
  battery_id                                               String          @db.Uuid
  from_station_id                                          String          @db.Uuid
  to_station_id                                            String          @db.Uuid
  transfer_reason                                          String          @db.VarChar(100)
  transferred_by                                           String          @db.Uuid
  transferred_at                                           DateTime        @default(now())
  notes                                                    String?
  transfer_status                                          TransferStatus? @default(completed)
  batteries                                                batteries       @relation(fields: [battery_id], references: [battery_id])
  stations_battery_transfer_logs_from_station_idTostations stations        @relation("battery_transfer_logs_from_station_idTostations", fields: [from_station_id], references: [station_id])
  stations_battery_transfer_logs_to_station_idTostations   stations        @relation("battery_transfer_logs_to_station_idTostations", fields: [to_station_id], references: [station_id])
  users                                                    users           @relation(fields: [transferred_by], references: [user_id])

  @@index([battery_id])
  @@index([from_station_id, transfer_status])
  @@index([to_station_id, transfer_status])
}

model bookings {
  booking_id                                   String            @id @db.Uuid
  booking_code                                 String            @unique @db.VarChar(20)
  user_id                                      String            @db.Uuid
  vehicle_id                                   String            @db.Uuid
  station_id                                   String            @db.Uuid
  battery_model                                String            @db.VarChar(50)
  scheduled_at                                 DateTime
  status                                       BookingStatus     @default(pending)
  checked_in_at                                DateTime?
  checked_in_by_staff_id                       String?           @db.Uuid
  notes                                        String?
  created_at                                   DateTime          @default(now())
  is_instant                                   Boolean           @default(false)
  locked_battery_id                            String?           @db.Uuid
  locked_subscription_id                       String?           @db.Uuid
  locked_swap_count                            Int               @default(0)
  locked_wallet_amount                         Decimal           @default(0) @db.Decimal(10, 2)
  locked_wallet_payment_id                     String?           @db.Uuid
  use_subscription                             Boolean           @default(true)
  locked_battery_previous_status               BatteryStatus?
  hold_expires_at                              DateTime?
  cancellation_reason                          String?
  cancellation_notes                           String?
  battery_history                              battery_history[]
  users_bookings_checked_in_by_staff_idTousers users?            @relation("bookings_checked_in_by_staff_idTousers", fields: [checked_in_by_staff_id], references: [user_id])
  stations                                     stations          @relation(fields: [station_id], references: [station_id])
  users_bookings_user_idTousers                users             @relation("bookings_user_idTousers", fields: [user_id], references: [user_id], onDelete: Cascade)
  vehicles                                     vehicles          @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade)
  transactions                                 transactions?

  @@index([checked_in_at])
  @@index([is_instant])
  @@index([station_id, status])
  @@index([status, scheduled_at])
  @@index([user_id, status])
}

model notifications {
  notification_id String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @db.Uuid
  type            String   @db.VarChar(50)
  title           String   @db.VarChar(200)
  message         String
  is_read         Boolean  @default(false)
  data            Json?
  created_at      DateTime @default(now())
  users           users    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([created_at])
  @@index([type])
  @@index([user_id])
  @@index([user_id, is_read])
}

model payments {
  payment_id          String              @id @db.Uuid
  transaction_id      String?             @unique @db.Uuid
  subscription_id     String?             @db.Uuid
  user_id             String              @db.Uuid
  amount              Decimal             @db.Decimal(10, 2)
  payment_method      PaymentMethod
  payment_status      PaymentStatus       @default(pending)
  payment_gateway_ref String?             @db.VarChar(100)
  paid_at             DateTime?
  created_at          DateTime            @default(now())
  topup_package_id    String?             @db.Uuid
  payment_type        PaymentType         @default(OTHER)
  metadata            Json?
  user_subscriptions  user_subscriptions? @relation(fields: [subscription_id], references: [subscription_id], onDelete: Cascade)
  topup_packages      topup_packages?     @relation(fields: [topup_package_id], references: [package_id], onDelete: Cascade)
  transactions        transactions?       @relation(fields: [transaction_id], references: [transaction_id], onDelete: Cascade)
  users               users               @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([payment_status, created_at])
  @@index([topup_package_id])
  @@index([user_id, payment_status])
}

model service_packages {
  package_id           String               @id @db.Uuid
  name                 String               @db.VarChar(100)
  description          String?
  price                Decimal              @db.Decimal(10, 2)
  swap_limit           Int?
  duration_days        Int
  battery_models       Json?
  is_active            Boolean              @default(true)
  created_at           DateTime             @default(now())
  updated_at           DateTime
  battery_capacity_kwh Int
  billing_cycle        PackageBillingCycle  @default(monthly)
  benefits             Json?
  metadata             Json?
  user_subscriptions   user_subscriptions[]

  @@index([is_active])
}

model staff_schedules {
  schedule_id String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  staff_id    String         @db.Uuid
  station_id  String?        @db.Uuid
  shift_date  DateTime       @db.Date
  shift_start DateTime       @db.Timestamptz(6)
  shift_end   DateTime       @db.Timestamptz(6)
  status      ScheduleStatus @default(scheduled)
  notes       String?
  created_at  DateTime       @default(now()) @db.Timestamptz(6)
  updated_at  DateTime       @default(now()) @db.Timestamptz(6)
  users       users          @relation(fields: [staff_id], references: [user_id], onDelete: Cascade)
  stations    stations?      @relation(fields: [station_id], references: [station_id])

  @@index([staff_id, shift_date])
}

model station_ratings {
  rating_id      String       @id @db.Uuid
  user_id        String       @db.Uuid
  station_id     String       @db.Uuid
  transaction_id String       @unique @db.Uuid
  rating         Int
  comment        String?
  created_at     DateTime     @default(now())
  updated_at     DateTime
  stations       stations     @relation(fields: [station_id], references: [station_id])
  transactions   transactions @relation(fields: [transaction_id], references: [transaction_id], onDelete: Cascade)
  users          users        @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([station_id])
  @@index([user_id])
}

model stations {
  station_id                                                            String                  @id @db.Uuid
  name                                                                  String                  @db.VarChar(100)
  address                                                               String                  @db.VarChar(255)
  latitude                                                              Decimal?                @db.Decimal(10, 6)
  longitude                                                             Decimal?                @db.Decimal(10, 6)
  capacity                                                              Int
  supported_models                                                      Json
  operating_hours                                                       String?                 @db.VarChar(50)
  status                                                                StationStatus           @default(active)
  created_at                                                            DateTime                @default(now())
  updated_at                                                            DateTime
  batteries                                                             batteries[]
  battery_transfer_logs_battery_transfer_logs_from_station_idTostations battery_transfer_logs[] @relation("battery_transfer_logs_from_station_idTostations")
  battery_transfer_logs_battery_transfer_logs_to_station_idTostations   battery_transfer_logs[] @relation("battery_transfer_logs_to_station_idTostations")
  battery_pricings                                                      battery_pricings[]
  bookings                                                              bookings[]
  staff_schedules                                                       staff_schedules[]
  station_ratings                                                       station_ratings[]
  transactions                                                          transactions[]
  users                                                                 users[]
}

model support_tickets {
  ticket_id                                         String           @id @db.Uuid
  ticket_number                                     String           @unique @db.VarChar(20)
  user_id                                           String           @db.Uuid
  category                                          TicketCategory
  subject                                           String           @db.VarChar(100)
  description                                       String
  priority                                          TicketPriority   @default(medium)
  status                                            TicketStatus     @default(open)
  assigned_to_staff_id                              String?          @db.Uuid
  resolved_at                                       DateTime?
  created_at                                        DateTime         @default(now())
  updated_at                                        DateTime
  users_support_tickets_assigned_to_staff_idTousers users?           @relation("support_tickets_assigned_to_staff_idTousers", fields: [assigned_to_staff_id], references: [user_id])
  users_support_tickets_user_idTousers              users            @relation("support_tickets_user_idTousers", fields: [user_id], references: [user_id], onDelete: Cascade)
  ticket_replies                                    ticket_replies[]

  @@index([assigned_to_staff_id, status])
  @@index([user_id, status])
}

model ticket_replies {
  reply_id        String          @id @db.Uuid
  ticket_id       String          @db.Uuid
  user_id         String          @db.Uuid
  message         String
  is_staff        Boolean         @default(false)
  created_at      DateTime        @default(now())
  support_tickets support_tickets @relation(fields: [ticket_id], references: [ticket_id], onDelete: Cascade)
  users           users           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model topup_packages {
  package_id    String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String     @db.VarChar(100)
  description   String?
  topup_amount  Decimal    @db.Decimal(10, 2)
  bonus_amount  Decimal    @db.Decimal(10, 2)
  actual_amount Decimal    @db.Decimal(10, 2)
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now())
  payments      payments[]

  @@index([is_active])
}

model transactions {
  transaction_id                                   String           @id @db.Uuid
  transaction_code                                 String           @unique @db.VarChar(30)
  booking_id                                       String           @unique @db.Uuid
  user_id                                          String           @db.Uuid
  vehicle_id                                       String           @db.Uuid
  station_id                                       String           @db.Uuid
  old_battery_id                                   String           @db.Uuid
  new_battery_id                                   String           @db.Uuid
  staff_id                                         String           @db.Uuid
  swap_at                                          DateTime         @default(now())
  swap_started_at                                  DateTime?
  swap_completed_at                                DateTime?
  swap_duration_minutes                            Int?
  payment_status                                   PaymentStatus    @default(pending)
  amount                                           Decimal          @default(0) @db.Decimal(10, 2)
  notes                                            String?
  created_at                                       DateTime         @default(now())
  payments                                         payments?
  station_ratings                                  station_ratings?
  bookings                                         bookings         @relation(fields: [booking_id], references: [booking_id], onDelete: Cascade)
  batteries_transactions_new_battery_idTobatteries batteries        @relation("transactions_new_battery_idTobatteries", fields: [new_battery_id], references: [battery_id])
  batteries_transactions_old_battery_idTobatteries batteries        @relation("transactions_old_battery_idTobatteries", fields: [old_battery_id], references: [battery_id])
  users_transactions_staff_idTousers               users            @relation("transactions_staff_idTousers", fields: [staff_id], references: [user_id])
  stations                                         stations         @relation(fields: [station_id], references: [station_id])
  users_transactions_user_idTousers                users            @relation("transactions_user_idTousers", fields: [user_id], references: [user_id], onDelete: Cascade)
  vehicles                                         vehicles         @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade)

  @@index([payment_status])
  @@index([station_id, created_at])
  @@index([user_id, payment_status])
}

model user_subscriptions {
  subscription_id     String             @id @db.Uuid
  user_id             String             @db.Uuid
  package_id          String             @db.Uuid
  start_date          DateTime
  end_date            DateTime
  remaining_swaps     Int?
  status              SubscriptionStatus @default(active)
  auto_renew          Boolean            @default(false)
  created_at          DateTime           @default(now())
  updated_at          DateTime
  cancelled_at        DateTime?
  cancellation_reason String?
  metadata            Json?
  payments            payments[]
  service_packages    service_packages   @relation(fields: [package_id], references: [package_id])
  users               users              @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([status, end_date])
  @@index([user_id, status])
}

model users {
  user_id                                                     String                  @id @db.Uuid
  full_name                                                   String                  @db.VarChar(100)
  email                                                       String                  @unique @db.VarChar(100)
  password_hash                                               String?                 @db.VarChar(255)
  phone                                                       String?                 @db.VarChar(20)
  avatar                                                      String?                 @db.VarChar(255)
  role                                                        UserRole                @default(DRIVER)
  station_id                                                  String?                 @db.Uuid
  status                                                      UserStatus              @default(ACTIVE)
  created_at                                                  DateTime                @default(now())
  updated_at                                                  DateTime
  last_login_at                                               DateTime?
  battery_history                                             battery_history[]
  battery_transfer_logs                                       battery_transfer_logs[]
  bookings_bookings_checked_in_by_staff_idTousers             bookings[]              @relation("bookings_checked_in_by_staff_idTousers")
  bookings_bookings_user_idTousers                            bookings[]              @relation("bookings_user_idTousers")
  notifications                                               notifications[]
  payments                                                    payments[]
  staff_schedules                                             staff_schedules[]
  station_ratings                                             station_ratings[]
  support_tickets_support_tickets_assigned_to_staff_idTousers support_tickets[]       @relation("support_tickets_assigned_to_staff_idTousers")
  support_tickets_support_tickets_user_idTousers              support_tickets[]       @relation("support_tickets_user_idTousers")
  ticket_replies                                              ticket_replies[]
  transactions_transactions_staff_idTousers                   transactions[]          @relation("transactions_staff_idTousers")
  transactions_transactions_user_idTousers                    transactions[]          @relation("transactions_user_idTousers")
  user_subscriptions                                          user_subscriptions[]
  stations                                                    stations?               @relation(fields: [station_id], references: [station_id])
  vehicles                                                    vehicles[]
  wallets                                                     wallets?

  @@index([station_id])
}

model vehicles {
  vehicle_id         String            @id @db.Uuid
  user_id            String            @db.Uuid
  license_plate      String            @unique @db.VarChar(20)
  vehicle_type       VehicleType
  make               String?           @db.VarChar(50)
  model              String?           @db.VarChar(50)
  year               Int?
  battery_model      String            @db.VarChar(50)
  created_at         DateTime          @default(now())
  updated_at         DateTime
  current_battery_id String?           @db.Uuid
  battery_history    battery_history[]
  bookings           bookings[]
  transactions       transactions[]
  batteries          batteries?        @relation(fields: [current_battery_id], references: [battery_id], onUpdate: NoAction)
  users              users             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model wallets {
  wallet_id  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @unique @db.Uuid
  balance    Decimal  @default(0) @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

enum BatteryHistoryAction {
  reserved
  released
  issued
  returned
  maintenance
  damaged
  reassigned
}

enum BatteryStatus {
  full
  charging
  in_use
  maintenance
  damaged
  reserved
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum PackageBillingCycle {
  monthly
  yearly
  custom
}

enum PaymentMethod {
  cash
  vnpay
  momo
  credit_card
  wallet
}

enum PaymentStatus {
  pending
  completed
  failed
  reserved
  refunded
  forfeited
}

enum PaymentType {
  SWAP
  TOPUP
  PACKAGE_PURCHASE
  PACKAGE_REFUND
  PENALTY
  OTHER
  SUBSCRIPTION
  REFUND
}

enum ScheduleStatus {
  scheduled
  completed
  absent
  cancelled
}

enum StationStatus {
  active
  maintenance
  closed
}

enum SubscriptionStatus {
  active
  expired
  cancelled
}

enum TicketCategory {
  battery_issue
  station_issue
  payment_issue
  service_complaint
  other
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

enum TransferStatus {
  pending
  in_transit
  completed
  cancelled
}

enum UserRole {
  DRIVER
  STAFF
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum VehicleType {
  car
  motorbike
}
